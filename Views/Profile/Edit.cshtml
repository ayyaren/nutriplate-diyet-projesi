@model Nutriplate.Web.ViewModels.ProfileViewModel

@{
    ViewData["Title"] = "Profilim";
}

<div class="profile-page">

    <div class="profile-header d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h2 class="profile-title mb-1">Profilim</h2>
            <p class="text-muted mb-0">
                Vücut bilgilerini ve yaşam tarzını güncelleyerek daha doğru kalori ve makro hedefleri alabilirsin.
            </p>
        </div>

        <a asp-controller="Dashboard"
           asp-action="Index"
           class="btn btn-outline-secondary btn-sm">
            ⬅ Dashboard'a Dön
        </a>
    </div>

    @if (ViewBag.Success != null)
    {
        <div class="alert alert-success">
            @ViewBag.Success
        </div>
    }

    <div class="card profile-card shadow-sm">
        <div class="card-body">
            <form asp-action="Edit" method="post" class="row g-3">
                @Html.AntiForgeryToken()

                <!-- KİŞİSEL BİLGİLER -->
                <div class="col-12 mb-2">
                    <h5 class="section-title mb-0">Kişisel Bilgiler</h5>
                    <p class="section-subtext">Seni daha iyi tanıyalım.</p>
                </div>

                <div class="col-md-6">
                    <label asp-for="Name" class="form-label fw-semibold">Ad Soyad</label>
                    <input asp-for="Name" class="form-control" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Email" class="form-label fw-semibold">E-posta</label>
                    <input asp-for="Email" class="form-control" readonly />
                    <div class="form-text">E-posta adresi değiştirilemez.</div>
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="BirthDate" class="form-label fw-semibold">Doğum Tarihi</label>
                    <input asp-for="BirthDate" type="date" class="form-control" id="BirthDate" onchange="calculateBodyMetrics()" />
                    <span asp-validation-for="BirthDate" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="Gender" class="form-label fw-semibold">Cinsiyet</label>
                    <select asp-for="Gender" class="form-select" id="Gender" onchange="calculateBodyMetrics()">
                        <option value="">Seç...</option>
                        <option value="Kadın">Kadın</option>
                        <option value="Erkek">Erkek</option>
                        <option value="Diğer">Belirtmek istemiyorum</option>
                    </select>
                    <span asp-validation-for="Gender" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="ActivityLevel" class="form-label fw-semibold">Aktivite Seviyesi</label>
                    <select asp-for="ActivityLevel" class="form-select" id="ActivityLevel" onchange="calculateBodyMetrics()">
                        <option value="">Seç...</option>
                        <option value="Düşük">Düşük</option>
                        <option value="Orta">Orta</option>
                        <option value="Yüksek">Yüksek</option>
                    </select>
                    <span asp-validation-for="ActivityLevel" class="text-danger"></span>
                </div>

                <!-- VÜCUT BİLGİLERİ -->
                <div class="col-12 mt-3 mb-2">
                    <h5 class="section-title mb-0">Vücut Bilgilerin</h5>
                    <p class="section-subtext">Kalori & makro hesaplamaları için kullanılır.</p>
                </div>

                <div class="col-md-4">
                    <label asp-for="HeightCm" class="form-label fw-semibold">Boy (cm)</label>
                    <div class="input-group">
                        <input asp-for="HeightCm" class="form-control" id="HeightCm" oninput="calculateBodyMetrics()" />
                        <span class="input-group-text">cm</span>
                    </div>
                    <span asp-validation-for="HeightCm" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="WeightKg" class="form-label fw-semibold">Kilo (kg)</label>
                    <div class="input-group">
                        <input asp-for="WeightKg" class="form-control" id="WeightKg" oninput="calculateBodyMetrics()" />
                        <span class="input-group-text">kg</span>
                    </div>
                    <span asp-validation-for="WeightKg" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="DailyCalorieTarget" class="form-label fw-semibold">Hedef Günlük Kalori</label>
                    <div class="input-group">
                        <input asp-for="DailyCalorieTarget" class="form-control" />
                        <span class="input-group-text">kcal</span>
                    </div>
                    <span asp-validation-for="DailyCalorieTarget" class="text-danger"></span>
                    <div class="form-text">
                        Boş bırakırsan ileride sistem otomatik hesaplayabilir.
                    </div>
                </div>

                <!-- VÜCUT ANALİZİ (ANLIK HESAPLAMA) -->
                <div class="col-12 mt-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body py-3">
                            <h6 class="section-title mb-2">Vücut Analizi (Anlık Hesaplama)</h6>
                            <p class="section-subtext mb-3">
                                Boy, kilo, doğum tarihi, cinsiyet ve aktivite bilgilerini girdikçe BMI, BMR ve önerilen kalori değerin burada hesaplanır.
                            </p>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <strong>BMI (Vücut Kitle İndeksi): </strong>
                                    <span id="bmiValue" class="text-success fw-semibold">-</span>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <strong>BMR (Bazal Metabolizma Hızı): </strong>
                                    <span id="bmrValue" class="text-primary fw-semibold">-</span>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <strong>Önerilen Günlük Kalori: </strong>
                                    <span id="calorieSuggestion" class="text-warning fw-semibold">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BUTONLAR -->
                <div class="col-12 d-flex justify-content-end gap-2 mt-4">
                    <a asp-controller="Dashboard"
                       asp-action="Index"
                       class="btn btn-outline-secondary">
                        İptal
                    </a>
                    <button type="submit" class="btn btn-success">
                        Değişiklikleri Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function calculateBodyMetrics() {
            const heightInput = document.getElementById("HeightCm");
            const weightInput = document.getElementById("WeightKg");
            const birthDateInput = document.getElementById("BirthDate");
            const genderInput = document.getElementById("Gender");
            const activityInput = document.getElementById("ActivityLevel");

            const bmiSpan = document.getElementById("bmiValue");
            const bmrSpan = document.getElementById("bmrValue");
            const calSpan = document.getElementById("calorieSuggestion");

            if (!bmiSpan || !bmrSpan || !calSpan) return;

            const height = parseFloat(heightInput?.value);
            const weight = parseFloat(weightInput?.value);
            const birthDateValue = birthDateInput?.value;
            const gender = genderInput?.value;
            const activityLevel = activityInput?.value;

            // BMI
            if (!height || !weight) {
                bmiSpan.innerText = "-";
            } else {
                const heightM = height / 100.0;
                const bmi = weight / (heightM * heightM);
                bmiSpan.innerText = bmi.toFixed(2);
            }

            // Yaş
            let age = 0;
            if (birthDateValue) {
                const birthDate = new Date(birthDateValue);
                const today = new Date();
                age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
            }

            // BMR
            let bmr = null;
            if (height && weight && age > 0 && gender) {
                if (gender === "Erkek") {
                    // Mifflin-St Jeor - Erkek
                    bmr = 10 * weight + 6.25 * height - 5 * age + 5;
                } else if (gender === "Kadın") {
                    // Mifflin-St Jeor - Kadın
                    bmr = 10 * weight + 6.25 * height - 5 * age - 161;
                } else {
                    // Diğer / Belirtmek istemiyorum: ortalama bir değer varsay
                    bmr = 10 * weight + 6.25 * height - 5 * age;
                }

                bmrSpan.innerText = bmr.toFixed(0) + " kcal";
            } else {
                bmrSpan.innerText = "-";
            }

            // Aktivite seviyesine göre önerilen günlük kalori
            if (bmr && activityLevel) {
                let factor = 1.2; // Düşük
                if (activityLevel === "Orta") factor = 1.375;
                if (activityLevel === "Yüksek") factor = 1.55;

                const suggested = bmr * factor;
                calSpan.innerText = suggested.toFixed(0) + " kcal";
            } else {
                calSpan.innerText = "-";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Sayfa yüklendiğinde mevcut profil verileriyle hesaplama yap
            calculateBodyMetrics();
        });
    </script>
}

<style>
    body {
        background: radial-gradient(circle at top, #e9f9ef 0, #f6fff9 40%, #ffffff 100%);
    }

    .profile-page {
        padding-top: 16px;
        padding-bottom: 32px;
        max-width: 900px;
        margin: 0 auto;
    }

    .profile-title {
        font-weight: 700;
        color: #1b2833;
    }

    .profile-card {
        border-radius: 18px;
        border: 1px solid #e1efe6;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: 600;
        color: #1b2833;
    }

    .section-subtext {
        font-size: 0.9rem;
        color: #7b8f9a;
    }
</style>
